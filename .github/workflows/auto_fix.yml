name: P3P暴力多线程扫描
on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 20线程暴力探测
        id: scanner
        run: |
          W="https://p3p-scanner.1747138780.workers.dev"
          echo "开始 10000-56000 全段随机轰炸..."
          
          # 随机抽取 8000 个端口进行探测
          for p in $(seq 10000 56000 | shuf | head -n 8000); do
            (
              res=$(curl -s --max-time 2 "$W/?port=$p")
              if [ "$res" = "OK" ]; then
                echo "$p" > result.txt
                echo "Bingo! 找到端口: $p"
              fi
            ) &

            # 这里的控制逻辑：每 40 个任务并行一次，防止过载
            if [[ $((p % 40)) -eq 0 ]]; then
              if [ -f result.txt ]; then break; fi
              wait
            fi
          done
          
          if [ -f result.txt ]; then
            P=$(cat result.txt)
            echo "p=$P" >> $GITHUB_OUTPUT
          fi

      - name: 自动更新文件
        if: steps.scanner.outputs.p != ''
        run: |
          NEW_P=${{ steps.scanner.outputs.p }}
          sed -i "s/focus169.org:[0-9]*/focus169.org:$NEW_P/g" list.txt
          git config --local user.email "bot@github.com"
          git config --local user.name "P3P-Fixer"
          git add list.txt
          git commit -m "多线程修复成功：端口 $NEW_P" || exit 0
          git push
