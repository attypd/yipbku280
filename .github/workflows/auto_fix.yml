name: P3P直播源全自动修复
on:
  schedule:
    - cron: '0 */2 * * *' # 每2小时检查一次
  workflow_dispatch:      # 允许手动立即运行

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 云端探测新端口
        id: scanner
        run: |
          # 这是你刚才测试成功的 Cloudflare 地址
          WORKER_URL="https://p3p-scanner.1747138780.workers.dev"
          
          # 从你的 list.txt 提取旧端口
          OLD_P=$(grep -oP 'focus169.org:\K[0-9]+' list.txt | head -n 1 || echo "54699")
          
          # 扫描序列：旧端口上下各 2000 个
          NEW_P=""
          for p in $(seq $OLD_P $((OLD_P+2000))) $(seq $((OLD_P-1)) -1 $((OLD_P-2000))); do
            res=$(curl -s --max-time 10 "$WORKER_URL/?port=$p")
            if [ "$res" = "OK" ]; then
              NEW_P=$p
              echo "p=$p" >> $GITHUB_OUTPUT
              break
            fi
          done

      - name: 批量替换并推送
        if: steps.scanner.outputs.p != ''
        run: |
          NEW_P=${{ steps.scanner.outputs.p }}
          # 这一行会把你 list.txt 里几百个 54699 一次性全换成新的
          sed -i "s/focus169.org:[0-9]*/focus169.org:$NEW_P/g" list.txt
          
          git config --local user.email "bot@github.com"
          git config --local user.name "P3P-Fixer"
          git add list.txt
          git commit -m "自动修复：端口已更新至 $NEW_P" || exit 0
          git push
