name: P3P直播源全自动修复
on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 全段暴力探测
        id: scanner
        run: |
          WORKER_URL="https://p3p-scanner.1747138780.workers.dev"
          
          # 核心逻辑：在 10000-45000 之间随机挑选端口，既高效又不容易被封
          # shuf 命令会将数字打乱，head -n 5000 表示这一轮先随机抽 5000 个幸运数字
          for p in $(seq 10000 45000 | shuf | head -n 5000); do
            res=$(curl -s --max-time 3 "$WORKER_URL/?port=$p")
            if [ "$res" = "OK" ]; then
              echo "p=$p" >> $GITHUB_OUTPUT
              echo "!!! 抓到有效端口: $p"
              break
            fi
          done

      - name: 批量替换并推送
        if: steps.scanner.outputs.p != ''
        run: |
          NEW_P=${{ steps.scanner.outputs.p }}
          sed -i "s/focus169.org:[0-9]*/focus169.org:$NEW_P/g" list.txt
          git config --local user.email "bot@github.com"
          git config --local user.name "P3P-Fixer"
          git add list.txt
          git commit -m "暴力搜索成功：端口已更新至 $NEW_P" || exit 0
          git push
